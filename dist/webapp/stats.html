<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Manga Poll</title>
    <link rel="stylesheet" href="index.css" />
    <link rel="apple-touch-icon" sizes="152x152" href="/apple-touch-icon.png" />
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png" />
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png" />
    <link rel="manifest" href="/site.webmanifest" />
    <link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5" />
    <meta name="msapplication-TileColor" content="#da532c" />
    <meta name="theme-color" content="#ffffff" />
  </head>
  <style>
    table {
        margin: 0 8px 0 24px;
        text-align: left;
        width: calc(100% - 40px);
        table-layout: fixed;
        border-spacing: 0;
    }
    td:first-child {
        width: 70%;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    td:nth-child(2),th:nth-child(2) {
        width: 40px;
    }
    td:nth-child(3),th:nth-child(3) {
        width: 95px;
    }
    td:nth-child(2),th:nth-child(2),
    td:nth-child(3),th:nth-child(3) {
        text-align: right;
        white-space: nowrap;
    }
    th {
        padding-bottom: 4px;
        border-bottom: solid 1px #a5acb9;
    }
    .host .title {
        position: sticky;
        top: 0;
        background: white;
        margin: 0;
        width: 100%;
        padding-right: 8px;
        cursor: pointer;
        padding-top: 4px;
    }
    #stats {
        overflow: auto;
        position: relative;
        margin-bottom: 16px;
    }
    .host .details {
        height: 0px;
        overflow: hidden;
        transition: height 0.5s;
    }
    .title h5::before {
        content: '+';
        position: absolute;
        left: 2px;
        top: -4px;
        font-size: 1.2rem;
        font-weight: bold;
    }
    @media (max-width: 650px) {
        td:nth-child(3),th:nth-child(3) {
            width: 75px;
        }
        table {
            margin: 0 8px 0 12px;   
            width: calc(100% - 20px);
        }
    }
    .expanded .title h5::before {
        content: 'â€“';
    }
    tr:nth-child(2n) td {
        background: #e3ebfb;
    }
  </style>
  <body>
      <h3>Stats</h3>
      <div id="stats">
        
      </div>
  </body>
  <script>
      function date(date) {
          const dateRaw = new Date(date).toISOString().split('T')[0]
          const [y, m, d] = dateRaw.split('-')
          return `${d}.${m}.${y.slice(-2)}`
      }
      document.addEventListener('click', () => {
          const closestTitle = event.target.closest('.host .title')
          const closestHost = event.target.closest('.host')

          if (closestTitle && closestTitle.contains(event.target)) {
              if (closestHost.classList.contains('expanded')) {
                closestHost.querySelector('.details').style.height = 0
                closestHost.classList.remove('expanded')
              }
              else {
                const height = closestHost.querySelector('.details table')?.getBoundingClientRect().height
                closestHost.querySelector('.details').style.height = `${height}px`
                closestHost.classList.add('expanded')
              }
          }
          
      })

      fetch('/api/sources/stats')
        .then(r => r.json())
        .then(({payload: stats}) => {
            Object.keys(stats)
                .sort((a, b) => stats[a].latest === stats[b].latest ? 0 : (Number(stats[a].latest) < Number(stats[b].latest) ? 1 : -1))
                .forEach((host) => {
                    const tableRows = Object.values(stats[host].sources)
                        .sort((a, b) => String(a.title).localeCompare(b.title))
                        .map(({title, latest, count}) => `
                            <td title="${title}">${title}</td>
                            <td>${count}</td>
                            <td>${date(latest)}</td>
                        `)

                    document.querySelector('#stats').innerHTML += `
                        <div class="host">
                            <table class="title">
                                <tbody>
                                    <tr>
                                        <td><h5>${host} (${Object.keys(stats[host].sources).length})</h5></td>
                                        <td></td>
                                        <td><b>${date(stats[host].latest)}</b></td>
                                    </tr>
                                </tbody>
                            </table>
                            <div class="details">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Title</th>
                                            <th>Chs.</th>
                                            <th>Updated</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            ${tableRows.join('</tr><tr>')}
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    `
                })
        })
  </script>  
</html>
